<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>vue 中如何自定义指令及其原理 | Jayconscious</title>
    <meta name="generator" content="VuePress 1.9.10">
    <link rel="icon" href="/blog/assets/img/favicon.ico">
    <meta name="description" content="Just playing around">
    
    <link rel="preload" href="/blog/assets/js/commons~ae3b4e4a.dbfb5fe9.js" as="script"><link rel="preload" href="/blog/assets/js/commons~7181f674.ee6873ca.js" as="script"><link rel="preload" href="/blog/assets/js/commons~786cfedb.2e287794.js" as="script"><link rel="preload" href="/blog/assets/js/commons~e97ebc98.aae432be.js" as="script"><link rel="preload" href="/blog/assets/js/commons~ec4c70c1.0795187d.js" as="script"><link rel="preload" href="/blog/assets/js/commons~92e9d224.7a0d719a.js" as="script"><link rel="preload" href="/blog/assets/js/commons~f79ce785.dd1e4e56.js" as="script"><link rel="preload" href="/blog/assets/js/commons~a72e7967.e5ba66d2.js" as="script"><link rel="preload" href="/blog/assets/js/commons~a90c22bc.0a1cfc6b.js" as="script"><link rel="preload" href="/blog/assets/js/commons~929f0a25.a32e45e9.js" as="script"><link rel="preload" href="/blog/assets/js/commons~c27f1b1d.2ea536b4.js" as="script"><link rel="preload" href="/blog/assets/js/commons~39c4c18e.e1c630df.js" as="script"><link rel="preload" href="/blog/assets/js/commons~0bcc290c.9afe8d39.js" as="script"><link rel="preload" href="/blog/assets/js/commons~2e021842.11a4698c.js" as="script"><link rel="preload" href="/blog/assets/js/commons~a984f759.709a0c8e.js" as="script"><link rel="preload" href="/blog/assets/js/commons~d6eb103f.1fb61434.js" as="script"><link rel="preload" href="/blog/assets/js/commons~5c078696.99eff8a4.js" as="script"><link rel="preload" href="/blog/assets/js/commons~f1a1cd68.3a9da768.js" as="script"><link rel="preload" href="/blog/assets/js/commons~30d5edbf.497bdc20.js" as="script"><link rel="preload" href="/blog/assets/js/commons~54aeb72e.563e335b.js" as="script"><link rel="preload" href="/blog/assets/css/19.styles.f49322ad.css" as="style"><link rel="preload" href="/blog/assets/js/commons~d0ae3f07.f49322ad.js" as="script"><link rel="preload" href="/blog/assets/css/17.styles.b19fcef8.css" as="style"><link rel="preload" href="/blog/assets/js/commons~b5906859.b19fcef8.js" as="script"><link rel="preload" href="/blog/assets/js/commons~ec8c427e.e5ca240a.js" as="script"><link rel="preload" href="/blog/assets/css/26.styles.dcf7561e.css" as="style"><link rel="preload" href="/blog/assets/js/commons~fdc6512a.dcf7561e.js" as="script"><link rel="preload" href="/blog/assets/css/7.styles.9569f3d0.css" as="style"><link rel="preload" href="/blog/assets/js/commons~6a2c4da6.9569f3d0.js" as="script"><link rel="preload" href="/blog/assets/js/commons~205977d4.e74f882a.js" as="script"><link rel="preload" href="/blog/assets/js/commons~7dcdd765.08781e7c.js" as="script"><link rel="preload" href="/blog/assets/js/app.767fbb5d.js" as="script">
    <link rel="stylesheet" href="/blog/assets/css/19.styles.f49322ad.css"><link rel="stylesheet" href="/blog/assets/css/17.styles.b19fcef8.css"><link rel="stylesheet" href="/blog/assets/css/26.styles.dcf7561e.css"><link rel="stylesheet" href="/blog/assets/css/7.styles.9569f3d0.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container" data-v-7dd95ae2><div data-v-7dd95ae2><div class="password-shadow password-wrapper-out" style="display:none;" data-v-59e6cb88 data-v-7dd95ae2 data-v-7dd95ae2><h3 class="title" data-v-59e6cb88>Jayconscious</h3> <p class="description" data-v-59e6cb88>Just playing around</p> <label id="box" class="inputBox" data-v-59e6cb88><input type="password" value="" data-v-59e6cb88> <span data-v-59e6cb88>Konck! Knock!</span> <button data-v-59e6cb88>OK</button></label> <div class="footer" data-v-59e6cb88><span data-v-59e6cb88><i class="iconfont reco-theme" data-v-59e6cb88></i> <a target="blank" href="https://vuepress-theme-reco.recoluan.com" data-v-59e6cb88>vuePress-theme-reco</a></span> <span data-v-59e6cb88><i class="iconfont reco-copyright" data-v-59e6cb88></i> <a data-v-59e6cb88><span data-v-59e6cb88>jayconscious</span>
          
        <span data-v-59e6cb88>2020 - </span>
        2025
      </a></span></div></div> <div class="hide" data-v-7dd95ae2><header class="navbar" data-v-7dd95ae2><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/blog/" class="home-link router-link-active"><!----> <span class="site-name">Jayconscious</span></a> <div class="links"><div class="color-picker"><a class="color-button"><i class="iconfont reco-color"></i></a> <div class="color-picker-menu" style="display:none;"><div class="mode-options"><h4 class="title">Choose mode</h4> <ul class="color-mode-options"><li class="dark">dark</li><li class="auto active">auto</li><li class="light">light</li></ul></div></div></div> <div class="search-box"><i class="iconfont reco-search"></i> <input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/blog/" class="nav-link"><i class="iconfont reco-home"></i>
  Home
</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="iconfont reco-category"></i>
      Category
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/blog/categories/Javascript/" class="nav-link"><i class="undefined"></i>
  Javascript
</a></li><li class="dropdown-item"><!----> <a href="/blog/categories/algorithm/" class="nav-link"><i class="undefined"></i>
  algorithm
</a></li><li class="dropdown-item"><!----> <a href="/blog/categories/Engineering/" class="nav-link"><i class="undefined"></i>
  Engineering
</a></li><li class="dropdown-item"><!----> <a href="/blog/categories/asyncProgramming/" class="nav-link"><i class="undefined"></i>
  asyncProgramming
</a></li><li class="dropdown-item"><!----> <a href="/blog/categories/Node.js/" class="nav-link"><i class="undefined"></i>
  Node.js
</a></li><li class="dropdown-item"><!----> <a href="/blog/categories/other/" class="nav-link"><i class="undefined"></i>
  other
</a></li><li class="dropdown-item"><!----> <a href="/blog/categories/protocol/" class="nav-link"><i class="undefined"></i>
  protocol
</a></li><li class="dropdown-item"><!----> <a href="/blog/categories/react/" class="nav-link"><i class="undefined"></i>
  react
</a></li><li class="dropdown-item"><!----> <a href="/blog/categories/Vue2/" class="nav-link"><i class="undefined"></i>
  Vue2
</a></li><li class="dropdown-item"><!----> <a href="/blog/categories/Vuex/" class="nav-link"><i class="undefined"></i>
  Vuex
</a></li></ul></div></div><div class="nav-item"><a href="/blog/tag/" class="nav-link"><i class="iconfont reco-tag"></i>
  Tag
</a></div><div class="nav-item"><a href="/blog/timeline/" class="nav-link"><i class="iconfont reco-date"></i>
  TimeLine
</a></div><div class="nav-item"><a href="https://github.com/jayconscious" target="_blank" rel="noopener noreferrer" class="nav-link external"><i class="undefined"></i>
  Github
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav></div></header> <div class="sidebar-mask" data-v-7dd95ae2></div> <aside class="sidebar" data-v-7dd95ae2><div class="personal-info-wrapper" data-v-1fad0c41 data-v-7dd95ae2><img src="/blog/assets/img/avatar.png" alt="author-avatar" class="personal-img" data-v-1fad0c41> <h3 class="name" data-v-1fad0c41>
    jayconscious
  </h3> <div class="num" data-v-1fad0c41><div data-v-1fad0c41><h3 data-v-1fad0c41>75</h3> <h6 data-v-1fad0c41>Articles</h6></div> <div data-v-1fad0c41><h3 data-v-1fad0c41>12</h3> <h6 data-v-1fad0c41>Tags</h6></div></div> <ul class="social-links" data-v-1fad0c41></ul> <hr data-v-1fad0c41></div> <nav class="nav-links"><div class="nav-item"><a href="/blog/" class="nav-link"><i class="iconfont reco-home"></i>
  Home
</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="iconfont reco-category"></i>
      Category
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/blog/categories/Javascript/" class="nav-link"><i class="undefined"></i>
  Javascript
</a></li><li class="dropdown-item"><!----> <a href="/blog/categories/algorithm/" class="nav-link"><i class="undefined"></i>
  algorithm
</a></li><li class="dropdown-item"><!----> <a href="/blog/categories/Engineering/" class="nav-link"><i class="undefined"></i>
  Engineering
</a></li><li class="dropdown-item"><!----> <a href="/blog/categories/asyncProgramming/" class="nav-link"><i class="undefined"></i>
  asyncProgramming
</a></li><li class="dropdown-item"><!----> <a href="/blog/categories/Node.js/" class="nav-link"><i class="undefined"></i>
  Node.js
</a></li><li class="dropdown-item"><!----> <a href="/blog/categories/other/" class="nav-link"><i class="undefined"></i>
  other
</a></li><li class="dropdown-item"><!----> <a href="/blog/categories/protocol/" class="nav-link"><i class="undefined"></i>
  protocol
</a></li><li class="dropdown-item"><!----> <a href="/blog/categories/react/" class="nav-link"><i class="undefined"></i>
  react
</a></li><li class="dropdown-item"><!----> <a href="/blog/categories/Vue2/" class="nav-link"><i class="undefined"></i>
  Vue2
</a></li><li class="dropdown-item"><!----> <a href="/blog/categories/Vuex/" class="nav-link"><i class="undefined"></i>
  Vuex
</a></li></ul></div></div><div class="nav-item"><a href="/blog/tag/" class="nav-link"><i class="iconfont reco-tag"></i>
  Tag
</a></div><div class="nav-item"><a href="/blog/timeline/" class="nav-link"><i class="iconfont reco-date"></i>
  TimeLine
</a></div><div class="nav-item"><a href="https://github.com/jayconscious" target="_blank" rel="noopener noreferrer" class="nav-link external"><i class="undefined"></i>
  Github
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav> <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><a href="/blog/vue/vue2/sourcecode/templateEngine" class="sidebar-heading clickable"><span>源码分析</span> <!----></a> <ul class="sidebar-links sidebar-group-items"><li><a href="/blog/vue/vue2/sourcecode/templateEngine.html" class="sidebar-link">Vue 模板解析</a></li><li><a href="/blog/vue/vue2/sourcecode/reactivityInDepth.html" class="sidebar-link">深入响应式原理</a></li><li><a href="/blog/vue/vue2/sourcecode/vueDiff.html" class="sidebar-link">virtual DOM &amp;&amp; Diff</a></li><li><a href="/blog/vue/vue2/sourcecode/asyncRender.html" class="sidebar-link">异步渲染</a></li></ul></section></li><li><section class="sidebar-group depth-0"><a href="/blog/vue/vue2/question/dataIsFn" class="sidebar-heading clickable open"><span>问题解答</span> <!----></a> <ul class="sidebar-links sidebar-group-items"><li><a href="/blog/vue/vue2/question/dataIsFn.html" class="sidebar-link">vue组件里的data为什么是函数返回一个对象</a></li><li><a href="/blog/vue/vue2/question/checkDupKeys.html" class="sidebar-link">为什么列表组件不用 index 作为 key</a></li><li><a href="/blog/vue/vue2/question/aboutNextTick.html" class="sidebar-link">怎么理解Vue中的$nextTick</a></li><li><a href="/blog/vue/vue2/question/directive.html" aria-current="page" class="active sidebar-link">vue 中如何自定义指令及其原理</a></li></ul></section></li></ul> </aside> <div class="password-shadow password-wrapper-in" style="display:none;" data-v-59e6cb88 data-v-7dd95ae2><h3 class="title" data-v-59e6cb88>vue 中如何自定义指令及其原理</h3> <!----> <label id="box" class="inputBox" data-v-59e6cb88><input type="password" value="" data-v-59e6cb88> <span data-v-59e6cb88>Konck! Knock!</span> <button data-v-59e6cb88>OK</button></label> <div class="footer" data-v-59e6cb88><span data-v-59e6cb88><i class="iconfont reco-theme" data-v-59e6cb88></i> <a target="blank" href="https://vuepress-theme-reco.recoluan.com" data-v-59e6cb88>vuePress-theme-reco</a></span> <span data-v-59e6cb88><i class="iconfont reco-copyright" data-v-59e6cb88></i> <a data-v-59e6cb88><span data-v-59e6cb88>jayconscious</span>
          
        <span data-v-59e6cb88>2020 - </span>
        2025
      </a></span></div></div> <div data-v-7dd95ae2><div data-v-7dd95ae2><main class="page"><section style="display:;"><div class="page-title"><h1 class="title">vue 中如何自定义指令及其原理</h1> <div data-v-8a445198><i class="iconfont reco-account" data-v-8a445198><span data-v-8a445198>jayconscious</span></i> <i class="iconfont reco-date" data-v-8a445198><span data-v-8a445198>3/15/2021</span></i> <i class="iconfont reco-eye" data-v-8a445198><span id="/blog/vue/vue2/question/directive.html" data-flag-title="Your Article Title" class="leancloud-visitors" data-v-8a445198><a class="leancloud-visitors-count" style="font-size:.9rem;font-weight:normal;color:#999;"></a></span></i> <i class="tags iconfont reco-tag" data-v-8a445198><span class="tag-item" data-v-8a445198>Vue</span></i></div></div> <div class="theme-reco-content content__default"><h2 id="如何自定义指令"><a href="#如何自定义指令" class="header-anchor">#</a> 如何自定义指令？</h2> <p>其实关于这个问题官方文档上已经有了很好的示例的，我们先来温故一下。</p> <p>除了核心功能默认内置的指令 (<code>v-model</code> 和 <code>v-show</code>)，Vue 也允许注册自定义指令。注意，在 Vue2.0 中，代码复用和抽象的主要形式是组件。然而，有的情况下，你仍然需要对普通 DOM 元素进行底层操作，这时候就会用到自定义指令。举个聚焦输入框的例子，如下：</p> <p>当页面加载时，该元素将获得焦点 (注意： <code>autofocus</code> 在移动版 <code>Safari</code> 上不工作)。事实上，只要你在打开这个页面后还没点击过任何内容，这个输入框就应当还是处于<strong>聚焦状态</strong>。现在让我们用指令来实现这个功能：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// 注册一个全局自定义指令 `v-focus`</span>
Vue<span class="token punctuation">.</span><span class="token function">directive</span><span class="token punctuation">(</span><span class="token string">'focus'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
<span class="token comment">// 当被绑定的元素插入到 DOM 中时……</span>
    <span class="token function-variable function">inserted</span><span class="token operator">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">el</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 聚焦元素</span>
        el<span class="token punctuation">.</span><span class="token function">focus</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><p>如果想注册局部指令，组件中也接受一个 <code>directives</code> 的选项：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token literal-property property">directives</span><span class="token operator">:</span> <span class="token punctuation">{</span>
  <span class="token literal-property property">focus</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token comment">// 指令的定义</span>
    <span class="token function-variable function">inserted</span><span class="token operator">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">el</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      el<span class="token punctuation">.</span><span class="token function">focus</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><p>然后你可以在模板中任何元素上使用新的 <code>v-focus property</code>，如下：</p> <div class="language-html line-numbers-mode"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token attr-name">v-focus</span><span class="token punctuation">&gt;</span></span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><h3 id="指令内部提供的钩子函数"><a href="#指令内部提供的钩子函数" class="header-anchor">#</a> 指令内部提供的钩子函数</h3> <p>一个指令定义对象可以提供如下几个钩子函数 (均为可选)：</p> <ul><li><code>bind:</code> 只调用一次，指令第一次绑定到元素时调用。在这里可以进行一次性的初始化设置。</li> <li><code>inserted:</code> 被绑定元素插入父节点时调用 (仅保证父节点存在，但不一定已被插入文档中)。</li> <li><code>update:</code> 所在组件的 VNode 更新时调用，**但是可能发生在其子 VNode 更新之前。**指令的值可能发生了改变，也可能没有。但是你可以通过比较更新前后的值来忽略不必要的模板更新 (详细的钩子函数参数见下)。</li> <li><code>componentUpdated:</code> 指令所在组件的 VNode 及<strong>其子VNode</strong>全部更新后调用。</li> <li><code>unbind:</code> 只调用一次，指令与元素解绑时调用。</li></ul> <h3 id="钩子函数参数"><a href="#钩子函数参数" class="header-anchor">#</a> 钩子函数参数</h3> <p>指令钩子函数会被传入以下参数：</p> <ul><li><code>el:</code> 指令所绑定的元素，可以用来直接操作 <code>DOM</code> 。</li> <li><code>binding：</code> 一个对象，包含以下 property：</li></ul> <ol><li><code>name：</code>指令名，不包括 <code>v-</code> 前缀。</li> <li><code>value：</code>指令的绑定值，例如：<code>v-my-directive=&quot;1 + 1&quot;</code> 中，绑定值为 2。</li> <li><code>oldValue：</code>指令绑定的前一个值，仅在 <code>update</code> 和 <code>componentUpdated</code> 钩子中可用。无论值是否改变都可用。</li> <li><code>expression：</code>字符串形式的指令表达式。例如 <code>v-my-directive=&quot;1 + 1&quot;</code> 中，表达式为 <code>&quot;1 + 1&quot;</code>。</li> <li><code>arg：</code> 传给指令的参数，可选。例如 <code>v-my-directive:foo</code> 中，参数为 &quot;foo&quot;。</li> <li><code>modifiers：</code>一个包含修饰符的对象。例如：<code>v-my-directive.foo.bar</code> 中，修饰符对象为 <code>{ foo: true, bar: true }</code>。</li></ol> <ul><li><code>vnode：</code> <code>Vue</code> 编译生成的虚拟节点。可以参考官网的 VNode API 来了解更多详情。</li> <li><code>oldVnode：</code>上一个虚拟节点，仅在 <code>update</code> 和 <code>componentUpdated</code> 钩子中可用。</li></ul> <div class="custom-block tip"><p class="title"></p><p>除了 <code>el</code> 之外，其它参数都应该是<strong>只读的</strong>，切勿进行修改。如果需要在<strong>钩子之间共享数据</strong>，建议通过元素的 <code>dataset</code> 来进行。</p></div><p>我们来看一个 <code>demo</code>,</p> <div class="language-html line-numbers-mode"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>hook-arguments-example<span class="token punctuation">&quot;</span></span> <span class="token attr-name"><span class="token namespace">v-demo:</span>foo.a.b</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>message<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><div class="language-js line-numbers-mode"><pre class="language-js"><code>Vue<span class="token punctuation">.</span><span class="token function">directive</span><span class="token punctuation">(</span><span class="token string">'demo'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
    <span class="token function-variable function">bind</span><span class="token operator">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">el<span class="token punctuation">,</span> binding<span class="token punctuation">,</span> vnode</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">var</span> s <span class="token operator">=</span> <span class="token constant">JSON</span><span class="token punctuation">.</span>stringify
        el<span class="token punctuation">.</span>innerHTML <span class="token operator">=</span>
        <span class="token string">'name: '</span>       <span class="token operator">+</span> <span class="token function">s</span><span class="token punctuation">(</span>binding<span class="token punctuation">.</span>name<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">'&lt;br&gt;'</span> <span class="token operator">+</span>
        <span class="token string">'value: '</span>      <span class="token operator">+</span> <span class="token function">s</span><span class="token punctuation">(</span>binding<span class="token punctuation">.</span>value<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">'&lt;br&gt;'</span> <span class="token operator">+</span>
        <span class="token string">'expression: '</span> <span class="token operator">+</span> <span class="token function">s</span><span class="token punctuation">(</span>binding<span class="token punctuation">.</span>expression<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">'&lt;br&gt;'</span> <span class="token operator">+</span>
        <span class="token string">'argument: '</span>   <span class="token operator">+</span> <span class="token function">s</span><span class="token punctuation">(</span>binding<span class="token punctuation">.</span>arg<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">'&lt;br&gt;'</span> <span class="token operator">+</span>
        <span class="token string">'modifiers: '</span>  <span class="token operator">+</span> <span class="token function">s</span><span class="token punctuation">(</span>binding<span class="token punctuation">.</span>modifiers<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">'&lt;br&gt;'</span> <span class="token operator">+</span>
        <span class="token string">'vnode keys: '</span> <span class="token operator">+</span> Object<span class="token punctuation">.</span><span class="token function">keys</span><span class="token punctuation">(</span>vnode<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token string">', '</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword">new</span> <span class="token class-name">Vue</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    <span class="token literal-property property">el</span><span class="token operator">:</span> <span class="token string">'#hook-arguments-example'</span><span class="token punctuation">,</span>
    <span class="token literal-property property">data</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token literal-property property">message</span><span class="token operator">:</span> <span class="token string">'hello!'</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br></div></div><p>来看一下渲染的结果：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">&quot;demo&quot;</span>
<span class="token literal-property property">value</span><span class="token operator">:</span> <span class="token string">&quot;hello!&quot;</span>
<span class="token literal-property property">expression</span><span class="token operator">:</span> <span class="token string">&quot;message&quot;</span>
<span class="token literal-property property">argument</span><span class="token operator">:</span> <span class="token string">&quot;foo&quot;</span>
<span class="token literal-property property">modifiers</span><span class="token operator">:</span> <span class="token punctuation">{</span><span class="token string-property property">&quot;a&quot;</span><span class="token operator">:</span><span class="token boolean">true</span><span class="token punctuation">,</span><span class="token string-property property">&quot;b&quot;</span><span class="token operator">:</span><span class="token boolean">true</span><span class="token punctuation">}</span>
vnode keys<span class="token operator">:</span> tag<span class="token punctuation">,</span> data<span class="token punctuation">,</span> children<span class="token punctuation">,</span> text<span class="token punctuation">,</span> elm<span class="token punctuation">,</span> ns<span class="token punctuation">,</span> context<span class="token punctuation">,</span> fnContext<span class="token punctuation">,</span> fnOptions<span class="token punctuation">,</span> fnScopeId<span class="token punctuation">,</span> key<span class="token punctuation">,</span> componentOptions<span class="token punctuation">,</span> componentInstance<span class="token punctuation">,</span> parent<span class="token punctuation">,</span> raw<span class="token punctuation">,</span> isStatic<span class="token punctuation">,</span> isRootInsert<span class="token punctuation">,</span> isComment<span class="token punctuation">,</span> isCloned<span class="token punctuation">,</span> isOnce<span class="token punctuation">,</span> asyncFactory<span class="token punctuation">,</span> asyncMeta<span class="token punctuation">,</span> isAsyncPlaceholder
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><h2 id="指令实现原理解析"><a href="#指令实现原理解析" class="header-anchor">#</a> 指令实现原理解析</h2> <p>通过上面官网的例子和我们平时的coding，我们基本上了解了 vue 的指令是如何使用的了，接下来我们从<strong>源码</strong>的视角来解析其实现的原理。</p> <h3 id="vue-directive-的定义"><a href="#vue-directive-的定义" class="header-anchor">#</a> Vue.directive 的定义：</h3> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">initAssetRegisters</span><span class="token punctuation">(</span><span class="token parameter">Vue</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token constant">ASSET_TYPES</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">type</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        Vue<span class="token punctuation">[</span>type<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span> <span class="token parameter">id<span class="token punctuation">,</span> definition</span> <span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>definition<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>options<span class="token punctuation">[</span>type <span class="token operator">+</span> <span class="token string">'s'</span><span class="token punctuation">]</span><span class="token punctuation">[</span>id<span class="token punctuation">]</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>type <span class="token operator">===</span> <span class="token string">'component'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token function">validateComponentName</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>type <span class="token operator">===</span> <span class="token string">'component'</span> <span class="token operator">&amp;&amp;</span> <span class="token function">isPlainObject</span><span class="token punctuation">(</span>definition<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    definition<span class="token punctuation">.</span>name <span class="token operator">=</span> definition<span class="token punctuation">.</span>name <span class="token operator">||</span> id<span class="token punctuation">;</span>
                    definition <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>options<span class="token punctuation">.</span>_base<span class="token punctuation">.</span><span class="token function">extend</span><span class="token punctuation">(</span>definition<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>type <span class="token operator">===</span> <span class="token string">'directive'</span> <span class="token operator">&amp;&amp;</span> <span class="token keyword">typeof</span> definition <span class="token operator">===</span> <span class="token string">'function'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment">// Tip: 兼容传参</span>
                    definition <span class="token operator">=</span> <span class="token punctuation">{</span>
                        <span class="token literal-property property">bind</span><span class="token operator">:</span> definition<span class="token punctuation">,</span>
                        <span class="token literal-property property">update</span><span class="token operator">:</span> definition
                    <span class="token punctuation">}</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token comment">// Tip: 储存一个 [ 'component', 'directive', 'filter' ]</span>
                <span class="token keyword">this</span><span class="token punctuation">.</span>options<span class="token punctuation">[</span>type <span class="token operator">+</span> <span class="token string">'s'</span><span class="token punctuation">]</span><span class="token punctuation">[</span>id<span class="token punctuation">]</span> <span class="token operator">=</span> definition<span class="token punctuation">;</span>
                <span class="token keyword">return</span> definition
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br></div></div><p>其实这个方法比较简单，就是在<code>vm.options.directives</code> 挂载了一个映射，比如 <code>vm.$options.directives.demo = { xxx }</code>，我们要看看这个指令是如何生效的。</p> <p>在没有下一步对源码进行分析之前，我们也能大概猜测出自定义指令是如何实现的。在模板编译阶段，从元素的属性中解析到指令属性，在不同生命周期元素阶段调用自定指令中不同的自定义逻辑。接下来配合源码来分析一下，将这个指令解析和生效分为三个阶段：<strong>模板编译阶段，</strong> <strong>生成VNode阶段，</strong> <strong>以及生成真实Dom的patch阶段。</strong></p> <p>我们以下面的代码片段为例：</p> <div class="language-html line-numbers-mode"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>hook-arguments-example<span class="token punctuation">&quot;</span></span> <span class="token attr-name"><span class="token namespace">v-demo:</span>foo.a.b</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>message<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><h3 id="模板编译阶段"><a href="#模板编译阶段" class="header-anchor">#</a> 模板编译阶段</h3> <p>对模板编译不熟悉的同学可以去回顾一下，这个阶段大致做了什么。这里不去详细介绍了，只关注指令这一部分。指令是元素的属性的一部分，所以在解析标签元素时，会被放入 <code>Ele Ast</code> 这个对象的 <code>attrs</code> 属性中。上述的示例，会被解析为这样：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token punctuation">[</span>
    <span class="token punctuation">{</span><span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">&quot;id&quot;</span><span class="token punctuation">,</span> value<span class="token operator">:</span> <span class="token string">&quot;hook-arguments-example&quot;</span><span class="token punctuation">,</span> start<span class="token operator">:</span> <span class="token number">5</span><span class="token punctuation">,</span> end<span class="token operator">:</span> <span class="token number">32</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span><span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">&quot;v-demo:foo.a.b&quot;</span><span class="token punctuation">,</span> value<span class="token operator">:</span> <span class="token string">&quot;message&quot;</span><span class="token punctuation">,</span> start<span class="token operator">:</span> <span class="token number">33</span><span class="token punctuation">,</span> end<span class="token operator">:</span> <span class="token number">57</span><span class="token punctuation">}</span>
<span class="token punctuation">]</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>在匹配到结束标签时，会进一步处理这些属性，比如：如果是指令的话，会被处理为<code>directives</code>挂载到这个<code>Ele Ast</code>对象上。</p> <p>具体的流程如下，在 <code>endTagMatch</code> 匹配到结束标签的时候，会去调用处理结束标签的 <code>parseEndTag</code> 函数，在这个函数内部回去调用 <code>parseHtml</code> 的配置项的 <code>options.end</code>，其中又回去调用 <code>closeElement</code>。</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">closeElement</span><span class="token punctuation">(</span><span class="token parameter">element</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// ...</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>inVPre <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>element<span class="token punctuation">.</span>processed<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        element <span class="token operator">=</span> <span class="token function">processElement</span><span class="token punctuation">(</span>element<span class="token punctuation">,</span> options<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// ...</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p>注意这里的 <code>processElement</code> 方法，主要是对解析过程中的元素进行各种加工。我们来看一下 <code>processElement</code> 的代码。</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">processElement</span><span class="token punctuation">(</span> <span class="token parameter">element<span class="token punctuation">,</span> options</span> <span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">processKey</span><span class="token punctuation">(</span>element<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">processRef</span><span class="token punctuation">(</span>element<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">processSlotContent</span><span class="token punctuation">(</span>element<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">processSlotOutlet</span><span class="token punctuation">(</span>element<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">processComponent</span><span class="token punctuation">(</span>element<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// ...</span>
    <span class="token function">processAttrs</span><span class="token punctuation">(</span>element<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> element
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><p>主要针对一堆元素属性的处理方法，我们需要关注 <code>processAttrs</code> 方法，它是处理指令和修饰符相关的方法。我们我看一下 <code>processAttrs</code> 的伪代码：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">processAttrs</span><span class="token punctuation">(</span><span class="token parameter">el</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">var</span> list <span class="token operator">=</span> el<span class="token punctuation">.</span>attrsList<span class="token punctuation">;</span>
    <span class="token keyword">var</span> i<span class="token punctuation">,</span> l<span class="token punctuation">,</span> name<span class="token punctuation">,</span> rawName<span class="token punctuation">,</span> value<span class="token punctuation">,</span> modifiers<span class="token punctuation">,</span> syncGen<span class="token punctuation">,</span> isDynamic<span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> l <span class="token operator">=</span> list<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i <span class="token operator">&lt;</span> l<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        name <span class="token operator">=</span> rawName <span class="token operator">=</span> list<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>name<span class="token punctuation">;</span>
        value <span class="token operator">=</span> list<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>value<span class="token punctuation">;</span>
        <span class="token comment">// Tip: 解析指令 dirRE = /^v-|^@|^:|^#/;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>dirRE<span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// ...</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>bindRE<span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment">// 处理 v-bind 情形</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>modifiers <span class="token operator">&amp;&amp;</span> modifiers<span class="token punctuation">.</span>prop<span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token punctuation">(</span>
                        <span class="token operator">!</span>el<span class="token punctuation">.</span>component <span class="token operator">&amp;&amp;</span> <span class="token function">platformMustUseProp</span><span class="token punctuation">(</span>el<span class="token punctuation">.</span>tag<span class="token punctuation">,</span> el<span class="token punctuation">.</span>attrsMap<span class="token punctuation">.</span>type<span class="token punctuation">,</span> name<span class="token punctuation">)</span>
                    <span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token function">addProp</span><span class="token punctuation">(</span>el<span class="token punctuation">,</span> name<span class="token punctuation">,</span> value<span class="token punctuation">,</span> list<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span> isDynamic<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                    <span class="token function">addAttr</span><span class="token punctuation">(</span>el<span class="token punctuation">,</span> name<span class="token punctuation">,</span> value<span class="token punctuation">,</span> list<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span> isDynamic<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>onRE<span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> 
                <span class="token comment">// 处理 v-on 情形</span>
                <span class="token function">addHandler</span><span class="token punctuation">(</span>el<span class="token punctuation">,</span> name<span class="token punctuation">,</span> value<span class="token punctuation">,</span> modifiers<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> warn$2<span class="token punctuation">,</span> list<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span> isDynamic<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span> 
                <span class="token comment">// 处理 常规指令情形</span>
                <span class="token comment">// Tip：给被解析到的元素，添加 directives 属性</span>
                <span class="token function">addDirective</span><span class="token punctuation">(</span>el<span class="token punctuation">,</span> name<span class="token punctuation">,</span> rawName<span class="token punctuation">,</span> value<span class="token punctuation">,</span> arg<span class="token punctuation">,</span> isDynamic<span class="token punctuation">,</span> modifiers<span class="token punctuation">,</span> list<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token comment">// ... 处理 literal attribute(文字属性)</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br></div></div><p>这里有个 <code>for</code> 循环去 <code>Ele Ast</code> 的 <code>attrsList</code>，然后按照不同的正则去解析他们，分别处理 <code>v-bind</code>，<code>v-on</code>以及 <code>v-xx</code>的情形。对于自定义的指令会通过 <code>addDirective</code> 给 <code>Ele Ast</code> 添加 directives 属性，如下：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code>directives <span class="token operator">=</span> <span class="token punctuation">[</span>
    <span class="token punctuation">{</span>
        <span class="token literal-property property">arg</span><span class="token operator">:</span> <span class="token string">&quot;foo&quot;</span> <span class="token punctuation">,</span> <span class="token literal-property property">end</span><span class="token operator">:</span> <span class="token number">57</span><span class="token punctuation">,</span> <span class="token literal-property property">isDynamicArg</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token literal-property property">modifiers</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token literal-property property">a</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> b<span class="token operator">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">&quot;demo&quot;</span><span class="token punctuation">,</span> <span class="token literal-property property">rawName</span><span class="token operator">:</span> <span class="token string">&quot;v-demo:foo.a.b&quot;</span><span class="token punctuation">,</span> <span class="token literal-property property">start</span><span class="token operator">:</span> <span class="token number">33</span><span class="token punctuation">,</span> <span class="token literal-property property">value</span><span class="token operator">:</span> <span class="token string">&quot;message&quot;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">]</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>在模板解析的第一段阶段指令解析为上述模样。在模板解析的第二阶段 <code>generate</code> 将解析得到的 <code>Ele Ast</code> 生成产生 <code>vNode</code> 的函数字符串。自定义指令也转化为下面的形式了，成为 <code>_c</code> 函数的第二个参数了。</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>&quot;{directives:[{name:&quot;demo&quot;,rawName:&quot;v-demo:foo.a.b&quot;,value:(message),expression:&quot;message&quot;,arg:&quot;foo&quot;,modifiers:{&quot;a&quot;:true,&quot;b&quot;:true}}],attrs:
{&quot;id&quot;:&quot;hook-arguments-example&quot;}}&quot;
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><h3 id="生成vnode阶段"><a href="#生成vnode阶段" class="header-anchor">#</a> 生成vNode阶段</h3> <p>在这个 <code>render</code> 函数生成 <code>vNode</code> 的阶段，生面的指令字符串会被挂载到 <code>vNode.data.directives</code> 属性下，</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code>vNode<span class="token punctuation">.</span>data<span class="token punctuation">.</span>directives <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">{</span>
    <span class="token literal-property property">arg</span><span class="token operator">:</span> <span class="token string">&quot;foo&quot;</span>
    <span class="token literal-property property">expression</span><span class="token operator">:</span> <span class="token string">&quot;message&quot;</span>
    <span class="token literal-property property">modifiers</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token literal-property property">a</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token literal-property property">b</span><span class="token operator">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span>
    <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">&quot;demo&quot;</span>
    <span class="token literal-property property">rawName</span><span class="token operator">:</span> <span class="token string">&quot;v-demo:foo.a.b&quot;</span>
    <span class="token literal-property property">value</span><span class="token operator">:</span> <span class="token string">&quot;hello!&quot;</span>
<span class="token punctuation">}</span><span class="token punctuation">]</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><h3 id="生成真实dom的patch阶段"><a href="#生成真实dom的patch阶段" class="header-anchor">#</a> 生成真实Dom的patch阶段</h3> <p>在这个由 <code>vNode</code> 生成真实 <code>Dom</code> 的阶段，<code>createElm</code> 会去调用 <code>invokeCreateHooks</code> （调用 <code>crate</code> 阶段所需要的函数）， 会去调用 <code>updateDirectives</code> 函数，这里面最终会去调用 <code>_update</code> 我们来看下代码：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">_update</span><span class="token punctuation">(</span><span class="token parameter">oldVnode<span class="token punctuation">,</span> vnode</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">var</span> isCreate <span class="token operator">=</span> oldVnode <span class="token operator">===</span> emptyNode<span class="token punctuation">;</span>
    
    <span class="token comment">// Tip: 获取到全局上自定义的指令函数</span>
    <span class="token keyword">var</span> oldDirs <span class="token operator">=</span> <span class="token function">normalizeDirectives$1</span><span class="token punctuation">(</span>oldVnode<span class="token punctuation">.</span>data<span class="token punctuation">.</span>directives<span class="token punctuation">,</span> oldVnode<span class="token punctuation">.</span>context<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">var</span> newDirs <span class="token operator">=</span> <span class="token function">normalizeDirectives$1</span><span class="token punctuation">(</span>vnode<span class="token punctuation">.</span>data<span class="token punctuation">.</span>directives<span class="token punctuation">,</span> vnode<span class="token punctuation">.</span>context<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">for</span> <span class="token punctuation">(</span>key <span class="token keyword">in</span> newDirs<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>oldDir<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// new directive, bind</span>
            <span class="token function">callHook$1</span><span class="token punctuation">(</span>dir<span class="token punctuation">,</span> <span class="token string">'bind'</span><span class="token punctuation">,</span> vnode<span class="token punctuation">,</span> oldVnode<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>dir<span class="token punctuation">.</span>def <span class="token operator">&amp;&amp;</span> dir<span class="token punctuation">.</span>def<span class="token punctuation">.</span>inserted<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                dirsWithInsert<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>dir<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token function">callHook$1</span><span class="token punctuation">(</span>dir<span class="token punctuation">,</span> <span class="token string">'update'</span><span class="token punctuation">,</span> vnode<span class="token punctuation">,</span> oldVnode<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>dirsWithInsert<span class="token punctuation">.</span>length<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">var</span> <span class="token function-variable function">callInsert</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">var</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> dirsWithInsert<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token function">callHook$1</span><span class="token punctuation">(</span>dirsWithInsert<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token string">'inserted'</span><span class="token punctuation">,</span> vnode<span class="token punctuation">,</span> oldVnode<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>isCreate<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">mergeVNodeHook</span><span class="token punctuation">(</span>vnode<span class="token punctuation">,</span> <span class="token string">'insert'</span><span class="token punctuation">,</span> callInsert<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token function">callInsert</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>dirsWithPostpatch<span class="token punctuation">.</span>length<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">mergeVNodeHook</span><span class="token punctuation">(</span>vnode<span class="token punctuation">,</span> <span class="token string">'postpatch'</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">var</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> dirsWithPostpatch<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token function">callHook$1</span><span class="token punctuation">(</span>dirsWithPostpatch<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token string">'componentUpdated'</span><span class="token punctuation">,</span> vnode<span class="token punctuation">,</span> oldVnode<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>isCreate<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span>key <span class="token keyword">in</span> oldDirs<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>newDirs<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment">// no longer present, unbind</span>
                <span class="token function">callHook$1</span><span class="token punctuation">(</span>oldDirs<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token string">'unbind'</span><span class="token punctuation">,</span> oldVnode<span class="token punctuation">,</span> oldVnode<span class="token punctuation">,</span> isDestroy<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br></div></div><p>在 <code>_update</code> 中，<code>normalizeDirectives$1</code> 很重要，是它将我们一开始全局自定义的指令函数对应到当前的节点上。此外，在不同的生命周期也会依据不同的条件去调用不同自定义指令函数。比如，不存在 <code>oldDir</code>，就会去调用初始化的<code>bind</code>。</p> <h2 id="总结"><a href="#总结" class="header-anchor">#</a> 总结</h2> <p>没有想象中的那么神秘，从一开始的 <code>Vue.directive</code> 全局函数的定义以及文档中给不同钩子函数的定义和灌入的参数，我们就有了大概的思路了。通过对自定义指令实现的一步步探究，对整个 <code>vue</code> 的流程有了更进一步的了解。此外让我印象深刻的是整个代码逻辑的组织，值得我们去进去挖掘和学习。</p></div></section> <footer class="page-edit"><!----> <div class="last-updated"><span class="prefix">上次更新: </span> <span class="time">1/21/2025, 8:55:01 AM</span></div></footer> <div class="page-nav"><p class="inner"><span class="prev"><a href="/blog/vue/vue2/question/aboutNextTick.html" class="prev">
          怎么理解Vue中的$nextTick
        </a></span> <!----></p></div> <div class="comments-wrapper" style="display:none;"><!----></div></main></div> <!----></div> <ul class="sub-sidebar sub-sidebar-wrapper" style="width:12rem;" data-v-b57cc07c data-v-7dd95ae2><li class="level-2" data-v-b57cc07c><a href="/blog/vue/vue2/question/directive.html#如何自定义指令" class="sidebar-link reco-side-如何自定义指令" data-v-b57cc07c>如何自定义指令？</a></li><li class="level-3" data-v-b57cc07c><a href="/blog/vue/vue2/question/directive.html#指令内部提供的钩子函数" class="sidebar-link reco-side-指令内部提供的钩子函数" data-v-b57cc07c>指令内部提供的钩子函数</a></li><li class="level-3" data-v-b57cc07c><a href="/blog/vue/vue2/question/directive.html#钩子函数参数" class="sidebar-link reco-side-钩子函数参数" data-v-b57cc07c>钩子函数参数</a></li><li class="level-2" data-v-b57cc07c><a href="/blog/vue/vue2/question/directive.html#指令实现原理解析" class="sidebar-link reco-side-指令实现原理解析" data-v-b57cc07c>指令实现原理解析</a></li><li class="level-3" data-v-b57cc07c><a href="/blog/vue/vue2/question/directive.html#vue-directive-的定义" class="sidebar-link reco-side-vue-directive-的定义" data-v-b57cc07c>Vue.directive 的定义：</a></li><li class="level-3" data-v-b57cc07c><a href="/blog/vue/vue2/question/directive.html#模板编译阶段" class="sidebar-link reco-side-模板编译阶段" data-v-b57cc07c>模板编译阶段</a></li><li class="level-3" data-v-b57cc07c><a href="/blog/vue/vue2/question/directive.html#生成vnode阶段" class="sidebar-link reco-side-生成vnode阶段" data-v-b57cc07c>生成vNode阶段</a></li><li class="level-3" data-v-b57cc07c><a href="/blog/vue/vue2/question/directive.html#生成真实dom的patch阶段" class="sidebar-link reco-side-生成真实dom的patch阶段" data-v-b57cc07c>生成真实Dom的patch阶段</a></li><li class="level-2" data-v-b57cc07c><a href="/blog/vue/vue2/question/directive.html#总结" class="sidebar-link reco-side-总结" data-v-b57cc07c>总结</a></li></ul></div></div></div><div class="global-ui"><!----><!----></div></div>
    <script src="/blog/assets/js/commons~ae3b4e4a.dbfb5fe9.js" defer></script><script src="/blog/assets/js/commons~7181f674.ee6873ca.js" defer></script><script src="/blog/assets/js/commons~786cfedb.2e287794.js" defer></script><script src="/blog/assets/js/commons~e97ebc98.aae432be.js" defer></script><script src="/blog/assets/js/commons~ec4c70c1.0795187d.js" defer></script><script src="/blog/assets/js/commons~92e9d224.7a0d719a.js" defer></script><script src="/blog/assets/js/commons~f79ce785.dd1e4e56.js" defer></script><script src="/blog/assets/js/commons~a72e7967.e5ba66d2.js" defer></script><script src="/blog/assets/js/commons~a90c22bc.0a1cfc6b.js" defer></script><script src="/blog/assets/js/commons~929f0a25.a32e45e9.js" defer></script><script src="/blog/assets/js/commons~c27f1b1d.2ea536b4.js" defer></script><script src="/blog/assets/js/commons~39c4c18e.e1c630df.js" defer></script><script src="/blog/assets/js/commons~0bcc290c.9afe8d39.js" defer></script><script src="/blog/assets/js/commons~2e021842.11a4698c.js" defer></script><script src="/blog/assets/js/commons~a984f759.709a0c8e.js" defer></script><script src="/blog/assets/js/commons~d6eb103f.1fb61434.js" defer></script><script src="/blog/assets/js/commons~5c078696.99eff8a4.js" defer></script><script src="/blog/assets/js/commons~f1a1cd68.3a9da768.js" defer></script><script src="/blog/assets/js/commons~30d5edbf.497bdc20.js" defer></script><script src="/blog/assets/js/commons~54aeb72e.563e335b.js" defer></script><script src="/blog/assets/js/commons~d0ae3f07.f49322ad.js" defer></script><script src="/blog/assets/js/commons~b5906859.b19fcef8.js" defer></script><script src="/blog/assets/js/commons~ec8c427e.e5ca240a.js" defer></script><script src="/blog/assets/js/commons~fdc6512a.dcf7561e.js" defer></script><script src="/blog/assets/js/commons~6a2c4da6.9569f3d0.js" defer></script><script src="/blog/assets/js/commons~205977d4.e74f882a.js" defer></script><script src="/blog/assets/js/commons~7dcdd765.08781e7c.js" defer></script><script src="/blog/assets/js/app.767fbb5d.js" defer></script>
  </body>
</html>
