<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>virtual DOM &amp;&amp; Diff | Jayconscious</title>
    <meta name="generator" content="VuePress 1.9.10">
    <link rel="icon" href="/blog/assets/img/favicon.ico">
    <meta name="description" content="Just playing around">
    
    <link rel="preload" href="/blog/assets/js/commons~ae3b4e4a.5f2ba438.js" as="script"><link rel="preload" href="/blog/assets/js/commons~7181f674.50d0b4df.js" as="script"><link rel="preload" href="/blog/assets/js/commons~786cfedb.786048a5.js" as="script"><link rel="preload" href="/blog/assets/js/commons~aace9167.553a6f78.js" as="script"><link rel="preload" href="/blog/assets/js/commons~9b484c39.75a837fe.js" as="script"><link rel="preload" href="/blog/assets/js/commons~7860dd99.3e592ac6.js" as="script"><link rel="preload" href="/blog/assets/js/commons~a72e7967.c80ea5c4.js" as="script"><link rel="preload" href="/blog/assets/js/commons~a90c22bc.2f091630.js" as="script"><link rel="preload" href="/blog/assets/js/commons~929f0a25.7a334799.js" as="script"><link rel="preload" href="/blog/assets/js/commons~c27f1b1d.cfa4ec66.js" as="script"><link rel="preload" href="/blog/assets/js/commons~cdd1d9fd.ebce550f.js" as="script"><link rel="preload" href="/blog/assets/js/commons~0bcc290c.77e959da.js" as="script"><link rel="preload" href="/blog/assets/js/commons~2e021842.0a54f4b0.js" as="script"><link rel="preload" href="/blog/assets/js/commons~7419dcdf.dcb3dab4.js" as="script"><link rel="preload" href="/blog/assets/js/commons~871781c5.96c883f0.js" as="script"><link rel="preload" href="/blog/assets/js/commons~d6eb103f.e5d10fcc.js" as="script"><link rel="preload" href="/blog/assets/js/commons~5c078696.3b5249cc.js" as="script"><link rel="preload" href="/blog/assets/js/commons~f1a1cd68.ca43ea50.js" as="script"><link rel="preload" href="/blog/assets/js/commons~f54afab4.fe93c982.js" as="script"><link rel="preload" href="/blog/assets/js/commons~54aeb72e.e9f4c96a.js" as="script"><link rel="preload" href="/blog/assets/css/21.styles.b423cf07.css" as="style"><link rel="preload" href="/blog/assets/js/commons~d0ae3f07.b423cf07.js" as="script"><link rel="preload" href="/blog/assets/css/18.styles.8745676a.css" as="style"><link rel="preload" href="/blog/assets/js/commons~b5906859.8745676a.js" as="script"><link rel="preload" href="/blog/assets/js/commons~ec8c427e.e5ca240a.js" as="script"><link rel="preload" href="/blog/assets/css/26.styles.ae90fdf4.css" as="style"><link rel="preload" href="/blog/assets/js/commons~fdc6512a.ae90fdf4.js" as="script"><link rel="preload" href="/blog/assets/css/5.styles.149ee583.css" as="style"><link rel="preload" href="/blog/assets/js/commons~6a2c4da6.149ee583.js" as="script"><link rel="preload" href="/blog/assets/js/commons~205977d4.e74f882a.js" as="script"><link rel="preload" href="/blog/assets/js/commons~7dcdd765.08781e7c.js" as="script"><link rel="preload" href="/blog/assets/js/app.b3ddbd33.js" as="script">
    <link rel="stylesheet" href="/blog/assets/css/21.styles.b423cf07.css"><link rel="stylesheet" href="/blog/assets/css/18.styles.8745676a.css"><link rel="stylesheet" href="/blog/assets/css/26.styles.ae90fdf4.css"><link rel="stylesheet" href="/blog/assets/css/5.styles.149ee583.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container" data-v-7dd95ae2><div data-v-7dd95ae2><div class="password-shadow password-wrapper-out" style="display:none;" data-v-59e6cb88 data-v-7dd95ae2 data-v-7dd95ae2><h3 class="title" data-v-59e6cb88>Jayconscious</h3> <p class="description" data-v-59e6cb88>Just playing around</p> <label id="box" class="inputBox" data-v-59e6cb88><input type="password" value="" data-v-59e6cb88> <span data-v-59e6cb88>Konck! Knock!</span> <button data-v-59e6cb88>OK</button></label> <div class="footer" data-v-59e6cb88><span data-v-59e6cb88><i class="iconfont reco-theme" data-v-59e6cb88></i> <a target="blank" href="https://vuepress-theme-reco.recoluan.com" data-v-59e6cb88>vuePress-theme-reco</a></span> <span data-v-59e6cb88><i class="iconfont reco-copyright" data-v-59e6cb88></i> <a data-v-59e6cb88><span data-v-59e6cb88>jayconscious</span>
          
        <span data-v-59e6cb88>2020 - </span>
        2025
      </a></span></div></div> <div class="hide" data-v-7dd95ae2><header class="navbar" data-v-7dd95ae2><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/blog/" class="home-link router-link-active"><!----> <span class="site-name">Jayconscious</span></a> <div class="links"><div class="color-picker"><a class="color-button"><i class="iconfont reco-color"></i></a> <div class="color-picker-menu" style="display:none;"><div class="mode-options"><h4 class="title">Choose mode</h4> <ul class="color-mode-options"><li class="dark">dark</li><li class="auto active">auto</li><li class="light">light</li></ul></div></div></div> <div class="search-box"><i class="iconfont reco-search"></i> <input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/blog/" class="nav-link"><i class="iconfont reco-home"></i>
  Home
</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="iconfont reco-category"></i>
      Category
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/blog/categories/algorithm/" class="nav-link"><i class="undefined"></i>
  algorithm
</a></li><li class="dropdown-item"><!----> <a href="/blog/categories/Javascript/" class="nav-link"><i class="undefined"></i>
  Javascript
</a></li><li class="dropdown-item"><!----> <a href="/blog/categories/Engineering/" class="nav-link"><i class="undefined"></i>
  Engineering
</a></li><li class="dropdown-item"><!----> <a href="/blog/categories/asyncProgramming/" class="nav-link"><i class="undefined"></i>
  asyncProgramming
</a></li><li class="dropdown-item"><!----> <a href="/blog/categories/Node.js/" class="nav-link"><i class="undefined"></i>
  Node.js
</a></li><li class="dropdown-item"><!----> <a href="/blog/categories/other/" class="nav-link"><i class="undefined"></i>
  other
</a></li><li class="dropdown-item"><!----> <a href="/blog/categories/protocol/" class="nav-link"><i class="undefined"></i>
  protocol
</a></li><li class="dropdown-item"><!----> <a href="/blog/categories/react/" class="nav-link"><i class="undefined"></i>
  react
</a></li><li class="dropdown-item"><!----> <a href="/blog/categories/Vue2/" class="nav-link"><i class="undefined"></i>
  Vue2
</a></li><li class="dropdown-item"><!----> <a href="/blog/categories/Vuex/" class="nav-link"><i class="undefined"></i>
  Vuex
</a></li></ul></div></div><div class="nav-item"><a href="/blog/tag/" class="nav-link"><i class="iconfont reco-tag"></i>
  Tag
</a></div><div class="nav-item"><a href="/blog/timeline/" class="nav-link"><i class="iconfont reco-date"></i>
  TimeLine
</a></div><div class="nav-item"><a href="https://github.com/jayconscious" target="_blank" rel="noopener noreferrer" class="nav-link external"><i class="undefined"></i>
  Github
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav></div></header> <div class="sidebar-mask" data-v-7dd95ae2></div> <aside class="sidebar" data-v-7dd95ae2><div class="personal-info-wrapper" data-v-1fad0c41 data-v-7dd95ae2><img src="/blog/assets/img/avatar.png" alt="author-avatar" class="personal-img" data-v-1fad0c41> <h3 class="name" data-v-1fad0c41>
    jayconscious
  </h3> <div class="num" data-v-1fad0c41><div data-v-1fad0c41><h3 data-v-1fad0c41>77</h3> <h6 data-v-1fad0c41>Articles</h6></div> <div data-v-1fad0c41><h3 data-v-1fad0c41>12</h3> <h6 data-v-1fad0c41>Tags</h6></div></div> <ul class="social-links" data-v-1fad0c41></ul> <hr data-v-1fad0c41></div> <nav class="nav-links"><div class="nav-item"><a href="/blog/" class="nav-link"><i class="iconfont reco-home"></i>
  Home
</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="iconfont reco-category"></i>
      Category
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/blog/categories/algorithm/" class="nav-link"><i class="undefined"></i>
  algorithm
</a></li><li class="dropdown-item"><!----> <a href="/blog/categories/Javascript/" class="nav-link"><i class="undefined"></i>
  Javascript
</a></li><li class="dropdown-item"><!----> <a href="/blog/categories/Engineering/" class="nav-link"><i class="undefined"></i>
  Engineering
</a></li><li class="dropdown-item"><!----> <a href="/blog/categories/asyncProgramming/" class="nav-link"><i class="undefined"></i>
  asyncProgramming
</a></li><li class="dropdown-item"><!----> <a href="/blog/categories/Node.js/" class="nav-link"><i class="undefined"></i>
  Node.js
</a></li><li class="dropdown-item"><!----> <a href="/blog/categories/other/" class="nav-link"><i class="undefined"></i>
  other
</a></li><li class="dropdown-item"><!----> <a href="/blog/categories/protocol/" class="nav-link"><i class="undefined"></i>
  protocol
</a></li><li class="dropdown-item"><!----> <a href="/blog/categories/react/" class="nav-link"><i class="undefined"></i>
  react
</a></li><li class="dropdown-item"><!----> <a href="/blog/categories/Vue2/" class="nav-link"><i class="undefined"></i>
  Vue2
</a></li><li class="dropdown-item"><!----> <a href="/blog/categories/Vuex/" class="nav-link"><i class="undefined"></i>
  Vuex
</a></li></ul></div></div><div class="nav-item"><a href="/blog/tag/" class="nav-link"><i class="iconfont reco-tag"></i>
  Tag
</a></div><div class="nav-item"><a href="/blog/timeline/" class="nav-link"><i class="iconfont reco-date"></i>
  TimeLine
</a></div><div class="nav-item"><a href="https://github.com/jayconscious" target="_blank" rel="noopener noreferrer" class="nav-link external"><i class="undefined"></i>
  Github
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav> <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><a href="/blog/vue/vue2/sourcecode/templateEngine" class="sidebar-heading clickable open"><span>源码分析</span> <!----></a> <ul class="sidebar-links sidebar-group-items"><li><a href="/blog/vue/vue2/sourcecode/templateEngine.html" class="sidebar-link">Vue 模板解析</a></li><li><a href="/blog/vue/vue2/sourcecode/reactivityInDepth.html" class="sidebar-link">深入响应式原理</a></li><li><a href="/blog/vue/vue2/sourcecode/vueDiff.html" aria-current="page" class="active sidebar-link">virtual DOM &amp;&amp; Diff</a></li><li><a href="/blog/vue/vue2/sourcecode/asyncRender.html" class="sidebar-link">异步渲染</a></li></ul></section></li><li><section class="sidebar-group depth-0"><a href="/blog/vue/vue2/question/dataIsFn" class="sidebar-heading clickable"><span>问题解答</span> <!----></a> <ul class="sidebar-links sidebar-group-items"><li><a href="/blog/vue/vue2/question/dataIsFn.html" class="sidebar-link">vue组件里的data为什么是函数返回一个对象</a></li><li><a href="/blog/vue/vue2/question/checkDupKeys.html" class="sidebar-link">为什么列表组件不用 index 作为 key</a></li><li><a href="/blog/vue/vue2/question/aboutNextTick.html" class="sidebar-link">怎么理解Vue中的$nextTick</a></li><li><a href="/blog/vue/vue2/question/directive.html" class="sidebar-link">vue 中如何自定义指令及其原理</a></li></ul></section></li></ul> </aside> <div class="password-shadow password-wrapper-in" style="display:none;" data-v-59e6cb88 data-v-7dd95ae2><h3 class="title" data-v-59e6cb88>virtual DOM &amp;&amp; Diff</h3> <!----> <label id="box" class="inputBox" data-v-59e6cb88><input type="password" value="" data-v-59e6cb88> <span data-v-59e6cb88>Konck! Knock!</span> <button data-v-59e6cb88>OK</button></label> <div class="footer" data-v-59e6cb88><span data-v-59e6cb88><i class="iconfont reco-theme" data-v-59e6cb88></i> <a target="blank" href="https://vuepress-theme-reco.recoluan.com" data-v-59e6cb88>vuePress-theme-reco</a></span> <span data-v-59e6cb88><i class="iconfont reco-copyright" data-v-59e6cb88></i> <a data-v-59e6cb88><span data-v-59e6cb88>jayconscious</span>
          
        <span data-v-59e6cb88>2020 - </span>
        2025
      </a></span></div></div> <div data-v-7dd95ae2><div data-v-7dd95ae2><main class="page"><section style="display:;"><div class="page-title"><h1 class="title">virtual DOM &amp;&amp; Diff</h1> <div data-v-8a445198><i class="iconfont reco-account" data-v-8a445198><span data-v-8a445198>jayconscious</span></i> <i class="iconfont reco-date" data-v-8a445198><span data-v-8a445198>2/24/2021</span></i> <i class="iconfont reco-eye" data-v-8a445198><span id="/blog/vue/vue2/sourcecode/vueDiff.html" data-flag-title="Your Article Title" class="leancloud-visitors" data-v-8a445198><a class="leancloud-visitors-count" style="font-size:.9rem;font-weight:normal;color:#999;"></a></span></i> <i class="tags iconfont reco-tag" data-v-8a445198><span class="tag-item" data-v-8a445198>Vue</span></i></div></div> <div class="theme-reco-content content__default"><h2 id="背景"><a href="#背景" class="header-anchor">#</a> 背景</h2> <p>算法都是为了解决实际的问题而诞生的，由于vue是有数据驱动视图的，由于浏览器的原生Dom节点信息复杂，操作十分消耗浏览器的性能，(其实单次的dom操作原生是最快的，但是多次的操作还是基于vNode机制最佳)由于虚拟dom，就是重要的中间产物。<code>virtual dom</code>就是vue为了描述真实dom，自己定义的一套 <code>AST</code>，再有相关的渲染函数生成真实的Dom。其中就有一个问题，但数据驱动视图不一定是全量更新，应该取用最小化差量更新原则，所以Diff算法由此诞生。</p> <p>在vue中 <code>template</code> 会被编译为 <code>render function</code>，然后配合响应式系统，将<code>render function</code>挂载在<code>render-watcher</code>中，当有数据更改的时候，调度中心 <code>Dep</code> 通知该<code>render-watcher</code> 执行 <code>render function</code>，完成视图的渲染与更新。</p> <p>整个流程的链路是没有什么问题的，但是我们思考一个极端的问题，每当我们去更新一个细微的节点都要全局更新，这显然是很浪费性能的。<code>为了解决这个问题</code>,vue中为了实现最小化更新，在vue中将真实dom 抽象成了 <code>virtual DOM</code>，即用一个js对象(VNode)来描述一个真实的dom。在有数据更新时，新旧VNode进行 <code>Diff</code>，找出尽可能少的我们需要更新的真实 DOM 节点，然后只更新需要更新的节点，从而解决频繁更新 DOM 产生的性能问题。</p> <div class="custom-block tip"><p class="title"></p><p>实际上，当某个数据被修改的时候，set方法会让闭包中的 <code>Dep</code> 调用 <code>notify</code> 通知所有订阅者 <code>Watcher</code>，<code>Watcher</code> 通过get方法执行 <code>vm._update(vm._render(), hydrating)</code>。<code>vm._render()</code> 生成新的VNode，<code>vm._update</code> 则实际是调用的是 <code>patch</code> 函数, 而 <code>patch</code> 则由 <code>createPatch</code> 生成。</p></div><h2 id="vnode-的定义"><a href="#vnode-的定义" class="header-anchor">#</a> VNode 的定义</h2> <p><code>virtual node</code>即虚拟节点，用来描述真实dom，本质上市一个js对象，在 Vue 的每一个组件实例中，会挂载一个<code>$createElement</code>函数，所有的<code>VNode</code>都是由这个函数创建的。当前全局的vnode生成函数挂载<code>vm.$options.render</code>，实质上是调用 <code>$createElement</code>，函数的入参是有模板编译器生成为可执行的string，然后调用<code>new Function</code>生成的函数。然后<code>vnode</code>作为<code>vm._update</code>入参，渲染页面。</p> <p>比如我们创建一个 test 的vnode节点：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// 声明 render function</span>
<span class="token function-variable function">render</span><span class="token operator">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">createElement</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 也可以使用 this.$createElement 创建 VNode</span>
    <span class="token keyword">return</span> <span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">'div'</span><span class="token punctuation">,</span> <span class="token string">'test'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment">// 以上 render 方法返回html片段 &lt;div&gt;test&lt;/div&gt;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div> <h2 id="diff"><a href="#diff" class="header-anchor">#</a> Diff</h2> <p>Diff 将新老 VNode 节点进行比对，然后将根据两者的比较结果进行最小单位地修改视图，而不是将整个视图根据新的 VNode 重绘，进而达到提升性能的目的</p> <h4 id="patch"><a href="#patch" class="header-anchor">#</a> patch</h4> <p>Vue.js 内部的 diff 被称为patch。其 diff 算法的是通过同层的树节点进行比较，而非对树进行逐层搜索遍历的方式，所以时间复杂度只有O(n)，是一种相当高效的算法。</p> <p>首先定义新老节点是否<code>相似</code>判定函数<code>sameVnode</code>：满足键值<code>key</code>和标签名<code>tag</code>必须一致等条件，返回<code>true</code>，否则<code>false</code>。</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">sameVnode</span><span class="token punctuation">(</span><span class="token parameter">a<span class="token punctuation">,</span> b</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token punctuation">(</span>
        a<span class="token punctuation">.</span>key <span class="token operator">===</span> b<span class="token punctuation">.</span>key <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>
            <span class="token punctuation">(</span>
                a<span class="token punctuation">.</span>tag <span class="token operator">===</span> b<span class="token punctuation">.</span>tag <span class="token operator">&amp;&amp;</span>
                a<span class="token punctuation">.</span>isComment <span class="token operator">===</span> b<span class="token punctuation">.</span>isComment <span class="token operator">&amp;&amp;</span>
                <span class="token function">isDef</span><span class="token punctuation">(</span>a<span class="token punctuation">.</span>data<span class="token punctuation">)</span> <span class="token operator">===</span> <span class="token function">isDef</span><span class="token punctuation">(</span>b<span class="token punctuation">.</span>data<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span>
                <span class="token function">sameInputType</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span> b<span class="token punctuation">)</span>
            <span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token punctuation">(</span>
                <span class="token comment">// 判断 isAsyncPlaceholder ...</span>
            <span class="token punctuation">)</span>
        <span class="token punctuation">)</span>
    <span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div><p>在进行<code>patch</code>之前，新老 <code>VNode</code> 是否满足条件<code>sameVnode(oldVnode, newVnode)</code>，满足条件之后，进入流程<code>patchVnode</code>，否则被判定为不相同节点，此时会移除老节点，创建新节点。</p> <div class="custom-block tip"><p class="title"></p><ol><li><code>sameVnode</code>这个方法几个判断节点是否相似的维度非常重要，可以在这样的场景下，最高效去判别当前的两个节点是否<code>相似</code>或者<code>相同</code>。<code>vNodeData</code>的不同会在后续 <code>pacthVnode</code> 中更新</li> <li><code>vm._updata</code> 调用的是 <code>vm.__patch__</code>, <code>vm.__patch__</code> === <code>patch</code>, 后者是由 <code>createPatch</code> 生成，这样做的目的是为了抽象出 <code>dom 操作</code> 这一层，比如在 <code>server</code> 环境。</li></ol></div><h4 id="patchvnode"><a href="#patchvnode" class="header-anchor">#</a> patchVnode</h4> <p><code>patchVnode</code> 的主要作用是判定如何对子节点进行更新。</p> <ol><li><p>第一种情况：如果新旧节点满足以下条件(isStatic相同、key相同、isCloned或者是isOnce(v-once))的话，依旧使用原来的实例</p></li> <li><p>第二种情况：如果 oldVnode 和 vnode 都有 children，就去更新子节点 updateChildren</p></li> <li><p>第三种情况：如果只存在 vnode 的孩子节点，那门只需要将 ch 节点全部插入到 elm 中</p></li> <li><p>第四种情况：如果只存在 oldVnode 的孩子节点，那只需要将 oldCh 全部删除即可</p></li> <li><p>第五种情况种情况： 如果是文本节点的话，更新文本</p></li></ol> <h4 id="updatechildren"><a href="#updatechildren" class="header-anchor">#</a> updateChildren</h4> <p>如果满足上述的第二种情况的话，就会执行 <code>updateChildren</code>。Diff 的核心，对比新老子节点数据，判定如何对子节点进行操作，在对比过程中，<code>由于老的子节点存在对当前真实 DOM 的引用，新的子节点只是一个 VNode 数组</code>，所以在进行遍历的过程中，若发现需要更新真实 DOM 的地方，则会直接在老的子节点上进行真实 DOM 的操作，等到遍历结束，新老子节点则已同步结束。</p> <p><code>updateChildren</code> 内部定义了4个<code>索引</code>变量，分别是<code>oldStartIdx</code>、<code>oldEndIdx</code>、<code>newStartIdx</code>、<code>newEndIdx</code>，分别表示正在 Diff 对比的新老子节点的左右边界点索引。
在老子节点数组中，索引在<code>oldStartIdx</code>与<code>oldEndIdx</code>中间的节点，表示老子节点中为被遍历处理的节点。在新的子节点数组中，索引在<code>newStartIdx</code>与<code>newEndIdx</code>中间的节点，表示新子节点中为被遍历处理的节点。</p> <p>所以这里就有了我们循环遍历的条件了，<code>oldStartIdx &lt;= oldEndIdx &amp;&amp; newStartIdx &lt;= newEndIdx</code> 或者 <code>oldStartIdx &gt; oldEndIdx || newStartIdx &gt; newEndIdx</code>。</p> <p><img src="/blog/assets/img/vue2/diff/diff1.png" alt="image"></p> <p>在遍历中，取出4索引对应的 Vnode节点：</p> <ul><li>oldStartIdx：oldStartVnode</li> <li>oldEndIdx：oldEndVnode</li> <li>newStartIdx：newStartVnode</li> <li>newEndIdx：newEndVnode</li></ul> <p>diff 过程中，如果存在key，并且满足<code>sameVnode</code>，会将该 DOM 节点进行复用，否则则会创建一个新的 DOM 节点。</p> <ol><li><p>第一种情况：<code>oldStartVnode</code> 不存在， <code>oldStartIdx</code> 向后移动</p></li> <li><p>第二种情况：<code>oldEndVnode</code> 不存在， <code>oldEndIdx</code> 向前移动</p></li></ol> <div class="custom-block tip"><p class="title"></p><p>为什么在循环开始会优先判断这两种情况，为什么会存在没有节点情况，框架在这里帮我们做了什么？</p></div><ol start="3"><li>第三种情况：先 <code>oldStartVnode</code> 和 <code>newStartVnode</code> 相似，<code>patch</code> 节点， <code>oldStartIdx</code> 与 <code>newStartIdx</code> 向后移动。</li></ol> <p><img src="/blog/assets/img/vue2/diff/diff2.png" alt="image"></p> <ol start="4"><li>第四种情况： <code>oldEndVnode</code> 和 <code>newEndVnode</code> 相似，<code>patch</code> 节点， <code>oldEndIdx</code> 与 <code>newEndIdx</code> 向前移动</li></ol> <p><img src="/blog/assets/img/vue2/diff/diff3.png" alt="image"></p> <ol start="5"><li>第五种情况：<code>oldStartVnode</code> 与 <code>newEndVnode</code> 相似，说明当前的这个节点已经向后移动了，<code>patch</code> 节点，还需要将 <code>oldStartVnode</code> 的真实 DOM 节点移动到 <code>oldEndVnode</code> 的后面，(<code>nodeOps.nextSibling(oldEndVnode.elm)</code>)，并且 <code>oldStartIdx</code> 前后移，<code>newEndIdx</code> 向前移</li></ol> <p><img src="/blog/assets/img/vue2/diff/diff4.png" alt="image"></p> <ol start="6"><li>第六种情况：<code>oldEndVnode</code> 与 <code>newStartVnode</code> 相似，说明当前的这个节点已经向前移动了，<code>patch</code> 节点，将 <code>oldEndVnode</code> 的真实 DOM 节点移动到<code>oldStartVnode</code> 的前面，并且 <code>oldEndIdx</code> 向前移，<code>newStartIdx</code> 前后移</li></ol> <p><img src="/blog/assets/img/vue2/diff/diff5.png" alt="image"></p> <p>当以上这些情况都不满足时，那么则在 <code>oldStartIdx</code> 与 <code>oldEndIdx</code> 之间查找与 <code>newStartVnode</code> 相似节点，若存在，<code>patch</code> 节点，则将匹配的节点真实 DOM 移动到 <code>oldStartVnode</code> 的前面。</p> <p><img src="/blog/assets/img/vue2/diff/diff6.png" alt="image"></p> <p>若不存在，说明 <code>newStartVnode</code> 为新节点，创建新节点放在 <code>oldStartVnode</code> 前面即可。</p> <p><img src="/blog/assets/img/vue2/diff/diff7.png" alt="image"></p> <p>当 <code>oldStartIdx &gt; oldEndIdx</code> 或者 <code>newStartIdx &gt; newEndIdx</code>，循环结束，这个时候我们需要处理那些未被遍历到的 VNode。</p> <p>当 <code>oldStartIdx &gt; oldEndIdx</code> 时，说明老的节点已经遍历完，而新的节点没遍历完，这个时候需要将新的节点创建之后放在 <code>oldEndVnode</code> 后面。</p> <p><img src="/blog/assets/img/vue2/diff/diff8.png" alt="image"></p> <p>当 <code>newStartIdx &gt; newEndIdx</code> 时，说明新的节点已经遍历完，而老的节点没遍历完，这个时候要将没遍历的老的节点全都删除。</p> <p><img src="/blog/assets/img/vue2/diff/diff9.png" alt="image"></p></div></section> <footer class="page-edit"><!----> <div class="last-updated"><span class="prefix">上次更新: </span> <span class="time">6/25/2025, 2:17:22 PM</span></div></footer> <div class="page-nav"><p class="inner"><span class="prev"><a href="/blog/vue/vue2/sourcecode/reactivityInDepth.html" class="prev">
          深入响应式原理
        </a></span> <span class="next"><a href="/blog/vue/vue2/sourcecode/asyncRender.html">
          异步渲染
        </a></span></p></div> <div class="comments-wrapper" style="display:none;"><!----></div></main></div> <!----></div> <ul class="sub-sidebar sub-sidebar-wrapper" style="width:12rem;" data-v-b57cc07c data-v-7dd95ae2><li class="level-2" data-v-b57cc07c><a href="/blog/vue/vue2/sourcecode/vueDiff.html#背景" class="sidebar-link reco-side-背景" data-v-b57cc07c>背景</a></li><li class="level-2" data-v-b57cc07c><a href="/blog/vue/vue2/sourcecode/vueDiff.html#vnode-的定义" class="sidebar-link reco-side-vnode-的定义" data-v-b57cc07c>VNode 的定义</a></li><li class="level-2" data-v-b57cc07c><a href="/blog/vue/vue2/sourcecode/vueDiff.html#diff" class="sidebar-link reco-side-diff" data-v-b57cc07c>Diff</a></li></ul></div></div></div><div class="global-ui"><!----><!----></div></div>
    <script src="/blog/assets/js/commons~ae3b4e4a.5f2ba438.js" defer></script><script src="/blog/assets/js/commons~7181f674.50d0b4df.js" defer></script><script src="/blog/assets/js/commons~786cfedb.786048a5.js" defer></script><script src="/blog/assets/js/commons~aace9167.553a6f78.js" defer></script><script src="/blog/assets/js/commons~9b484c39.75a837fe.js" defer></script><script src="/blog/assets/js/commons~7860dd99.3e592ac6.js" defer></script><script src="/blog/assets/js/commons~a72e7967.c80ea5c4.js" defer></script><script src="/blog/assets/js/commons~a90c22bc.2f091630.js" defer></script><script src="/blog/assets/js/commons~929f0a25.7a334799.js" defer></script><script src="/blog/assets/js/commons~c27f1b1d.cfa4ec66.js" defer></script><script src="/blog/assets/js/commons~cdd1d9fd.ebce550f.js" defer></script><script src="/blog/assets/js/commons~0bcc290c.77e959da.js" defer></script><script src="/blog/assets/js/commons~2e021842.0a54f4b0.js" defer></script><script src="/blog/assets/js/commons~7419dcdf.dcb3dab4.js" defer></script><script src="/blog/assets/js/commons~871781c5.96c883f0.js" defer></script><script src="/blog/assets/js/commons~d6eb103f.e5d10fcc.js" defer></script><script src="/blog/assets/js/commons~5c078696.3b5249cc.js" defer></script><script src="/blog/assets/js/commons~f1a1cd68.ca43ea50.js" defer></script><script src="/blog/assets/js/commons~f54afab4.fe93c982.js" defer></script><script src="/blog/assets/js/commons~54aeb72e.e9f4c96a.js" defer></script><script src="/blog/assets/js/commons~d0ae3f07.b423cf07.js" defer></script><script src="/blog/assets/js/commons~b5906859.8745676a.js" defer></script><script src="/blog/assets/js/commons~ec8c427e.e5ca240a.js" defer></script><script src="/blog/assets/js/commons~fdc6512a.ae90fdf4.js" defer></script><script src="/blog/assets/js/commons~6a2c4da6.149ee583.js" defer></script><script src="/blog/assets/js/commons~205977d4.e74f882a.js" defer></script><script src="/blog/assets/js/commons~7dcdd765.08781e7c.js" defer></script><script src="/blog/assets/js/app.b3ddbd33.js" defer></script>
  </body>
</html>
