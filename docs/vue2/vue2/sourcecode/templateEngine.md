# æ¨¡æ¿å¼•æ“

åœ¨ä½¿ç”¨ `vue` ä¹‹å‰ï¼Œæˆ–è®¸æˆ‘ä»¬å·²ç»æ¥è§¦è¿‡äº†å…¶ä»–çš„æ¨¡æ¿å¼•æ“ï¼Œæ¯”å¦‚ `underscore` çš„ `template` æ–¹æ³•ï¼Œæˆ–è€…æ˜¯ `handlebars` ç­‰ä¹‹ç±»ã€‚ä»–ä»¬çš„ä½œç”¨åŸºæœ¬ä¸Šå°±æ˜¯é€šè¿‡ç»“æ„åŒ–çš„ `html` æ¨¡æ¿ç‰‡æ®µæ³¨å…¥ä¸€äº›å˜é‡ï¼Œç»“åˆä¸€äº›è¾…åŠ©å‡½æ•°ä¾‹å¦‚ `each`ï¼Œç”Ÿæˆæˆ‘ä»¬æƒ³è¦çš„ `html` ç‰‡æ®µã€‚è¿™å¤§å¤§ç®€åŒ–äº†æˆ‘ä»¬å¯¹åŸç”Ÿ `dom` ä»¥åŠæ•°æ®æ‹¼æ¥æ“ä½œï¼Œæå‡äº†æˆ‘ä»¬çš„ç ”å‘æ•ˆç‡å’Œä½“éªŒã€‚è€Œ `vue`çš„æ¨¡æ¿å¼•æ“å†æ¬¡åŸºç¡€ä¸Šå†æ¬¡å°è£…æŠ½è±¡ï¼Œå¹¶å€ŸåŠ©æŠ½è±¡è¯­æ³•æ ‘ `AST` ï¼Œå¯¹åŠŸèƒ½è¿›ä¸€æ­¥çš„æ‰©å±•ï¼Œå’Œå“åº”å¼ç³»ç»Ÿå¾ˆå¥½çš„ç»“åˆåœ¨ä¸€èµ·äº†ã€‚`vue` æ¨¡æ¿å¼•æ“ç¼–è¯‘ä¸»è¦åˆ†ä¸ºä¸‰ä¸ªæ­¥éª¤ï¼š**å°†æ¨¡æ¿å­—ç¬¦ä¸²è½¬ä¸º`AST`ï¼Œå¯¹`AST`è¿›è¡Œå¤„ç†ï¼Œç”± `AST` ç”Ÿæˆä»£ç æ‰€éœ€çš„å­—ç¬¦ä¸²ã€‚**


## æ¨¡æ¿å­—ç¬¦ä¸²è½¬ä¸º AST

åœ¨ `js` ä¸­æˆ‘ä»¬æœ‰ `esprima`ç­‰è§£æå™¨ï¼Œå°†æˆ‘ä»¬çš„ `js` è§£æä¸ºæ ‡å‡†çš„ `AST`ã€‚è€Œåœ¨ `vue` ä¸­ï¼Œéœ€è¦å°†`æ¨¡æ¿å­—ç¬¦ä¸²` è§£æä¸º `elements AST`ï¼Œæ¯”å¦‚å°†

```html
<div>
    <span>{{ msg }}</span>
</div>
```
è§£æä¸ºå¦‚ä¸‹çš„ `js` å¯¹è±¡
```js
{
    attrsList: [],
    attrsMap: {},
    children: [{
        attrsList: [],
        attrsMap: {},
        children: [{
            end: 21,
            expression: "_s(msg)",
            start: 11,
            text: "{{ msg }}",
            tokens: [{
                @binding: "msg"
            }],
            type: 2
        }]
        end: 28,
        parent: {type: 1, tag: "div", attrsList: Array(0), attrsMap: {â€¦}, rawAttrsMap: {â€¦}, â€¦},
        plain: true,
        rawAttrsMap: {},
        start: 5,
        tag: "span",
        type: 1,
    }],
    end: 34,
    parent: undefined,
    plain: true,
    rawAttrsMap: {},
    start: 0,
    tag: "div",
    type: 1
}
```
é€šè¿‡ä¸Šé¢çš„ğŸŒ°ï¼Œæˆ‘ä»¬å¯ä»¥å¾ˆæ¸…æ™°çš„çœ‹å‡ºæ¥ï¼Œè§£æå™¨ä»€ä¹ˆï¼Œç„¶åæˆ‘ä»¬æ¥çœ‹çœ‹å®ƒå…·ä½“æ˜¯å¦‚ä½•å»è§£æçš„ã€‚è¿™éƒ¨åˆ†çš„åŠŸèƒ½å®ç°ä¸»è¦æ˜¯åœ¨ `baseCompile` å‡½æ•°ä¸­ï¼Œ`var ast = parse(template.trim(), options)` è°ƒç”¨ `parse` æ¥å®ç°çš„ã€‚æˆ‘ä»¬ä¼šå…ˆä»‹ç»ä¸€ä¸‹å®ƒæ˜¯æ€ä¹ˆåšçš„ï¼Œç„¶åå†å»åˆ†ææºç ã€‚

ä¸Šé¢è¿™æ®µæ¨¡æ¿å­—ç¬¦ä¸²ä¼šè¢«æ‰”åˆ° while ä¸­å»å¾ªç¯ï¼Œç„¶å **ä¸€æ®µä¸€æ®µ** çš„æˆªå–ï¼ŒæŠŠæˆªå–åˆ°çš„ **æ¯ä¸€å°æ®µå­—ç¬¦ä¸²** è¿›è¡Œè§£æï¼Œç›´åˆ°æœ€åæˆªæ²¡äº†ï¼Œä¹Ÿå°±è§£æå®Œäº†ã€‚

è¿™ä¸ªç®€å•çš„æ¨¡æ¿æˆªå–çš„è¿‡ç¨‹æ˜¯è¿™æ ·çš„ï¼š
```html
<div>
    <span>{{ msg }}</span>
</div>
```
```html
    <span>{{ msg }}</span>
</div>
```
```html
<span>{{ msg }}</span>
</div>
```
```html
{{ msg }}</span>
</div>
```
```html
</span>
</div>
```
```html
    
</div>
```
```html
</div>
```




